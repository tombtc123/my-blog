---
import { Image } from 'astro:assets';
import type { CollectionEntry, MarkdownHeading } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';

type Props = CollectionEntry<'blog'>['data'] & {
	headings?: MarkdownHeading[];
};

const { title, description, pubDate, updatedDate, heroImage, headings = [] } = Astro.props;
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={heroImage} />
		<style>
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
				padding-top: 0;
			}
			.hero-image {
				width: 100%;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				max-width: 100%;
				height: auto;
			}
			.article-container {
				display: flex;
				max-width: 1200px;
				margin: 0 auto;
				gap: 2rem;
				align-items: flex-start;
			}
			.prose {
				flex: 1;
				width: 680px;
				max-width: 100%;
				margin: 0 auto;
				padding: 1em;
				/* 字体、字号、行高、颜色等排版样式已在 global.css 中定义 */
			}
			
			@media (max-width: 768px) {
				.article-container {
					padding-left: 1.25rem;
					padding-right: 1.25rem;
				}
				.prose {
					padding-left: 0;
					padding-right: 0;
				}
			}
			.title {
				margin-bottom: 1em;
				padding: 1em 0;
				text-align: center;
				line-height: 1;
			}
			.title h1 {
				margin: 0 0 0.5em 0;
			}
			.date {
				margin-bottom: 0.5em;
				color: #666;
				transition: color 0.2s ease;
			}
			
			html.dark .date {
				color: #aaaaaa;
			}
			.last-updated-on {
				font-style: italic;
			}
			.toc {
				position: sticky;
				top: 2rem;
				width: 200px;
				max-height: calc(100vh - 4rem);
				overflow-y: auto;
				padding: 1rem 0;
				font-size: 0.875rem;
				line-height: 1.6;
			}
			.toc-title {
				font-size: 0.75rem;
				font-weight: 600;
				color: #888;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				margin-bottom: 0.75rem;
				transition: color 0.2s ease;
			}
			
			html.dark .toc-title {
				color: #aaaaaa;
			}
			.toc-list {
				list-style: none;
				padding: 0;
				margin: 0;
			}
			.toc-item {
				margin-bottom: 0.5rem;
			}
			.toc-link {
				color: #888;
				text-decoration: none;
				display: block;
				transition: color 0.2s;
			}
			
			html.dark .toc-link {
				color: #aaaaaa;
			}
			
			.toc-link:hover {
				color: var(--text-color);
			}
			
			.toc-link.active {
				color: var(--text-color);
				font-weight: 500;
			}
			.toc-item-h3 {
				padding-left: 1rem;
			}
			.prose :global(h2),
			.prose :global(h3) {
				scroll-margin-top: 2rem;
			}
			@media (max-width: 1024px) {
				.toc {
					display: none;
				}
				.article-container {
					flex-direction: column;
					padding: 0 1.25rem;
				}
				.prose {
					width: 100%;
					max-width: 100%;
					padding-left: 0;
					padding-right: 0;
				}
			}
			
			/* 回到顶部按钮 */
			.back-to-top {
				position: fixed;
				bottom: 2rem;
				right: 1.5rem;
				width: 48px;
				height: 48px;
				border-radius: 50%;
				background-color: #6366f1;
				color: #ffffff;
				border: none;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
				z-index: 40;
			}
			
			.back-to-top.visible {
				opacity: 1;
				pointer-events: auto;
			}
			
			.back-to-top:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
			}
			
			.back-to-top:active {
				transform: translateY(0);
			}
			
			.back-to-top-icon {
				width: 24px;
				height: 24px;
			}
			
			@media (max-width: 768px) {
				.back-to-top {
					bottom: 1.5rem;
					right: 1rem;
					width: 44px;
					height: 44px;
				}
				
				.back-to-top-icon {
					width: 20px;
					height: 20px;
				}
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article>
				<div class="hero-image">
					{heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
				</div>
				<div class="article-container">
					<div class="prose">
						<div class="title">
							<div class="date">
								<FormattedDate date={pubDate} />
								{
									updatedDate && (
										<div class="last-updated-on">
											Last updated on <FormattedDate date={updatedDate} />
										</div>
									)
								}
							</div>
							<h1>{title}</h1>
							<hr />
						</div>
						<slot />
					</div>
					{headings.length > 0 && (
						<nav class="toc" id="toc">
							<div class="toc-title">目录</div>
							<ul class="toc-list">
								{headings.map((heading) => {
									// 使用 heading.slug（如果存在），否则生成一个
									const slug = heading.slug || heading.text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').trim();
									return (
										<li class={`toc-item ${heading.depth === 3 ? 'toc-item-h3' : ''}`}>
											<a href={`#${slug}`} class="toc-link" data-slug={slug}>
												{heading.text}
											</a>
										</li>
									);
								})}
							</ul>
						</nav>
					)}
				</div>
			</article>
		</main>
		<Footer />
		<button id="back-to-top" class="back-to-top" aria-label="Back to top">
			<svg class="back-to-top-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="m18 15-6-6-6 6"></path>
			</svg>
		</button>
		<script>
			// 生成 slug（与 Astro 默认行为一致）
			function generateSlug(text) {
				return text
					.toLowerCase()
					.replace(/[^\w\s-]/g, '')
					.replace(/\s+/g, '-')
					.replace(/-+/g, '-')
					.trim();
			}

			// 为标题添加 ID（如果还没有）
			document.addEventListener('DOMContentLoaded', () => {
				const headings = document.querySelectorAll('.prose h2, .prose h3');
				headings.forEach((heading) => {
					if (!heading.id) {
						const text = heading.textContent || '';
						heading.id = generateSlug(text);
					}
				});

				// 平滑滚动
				const tocLinks = document.querySelectorAll('.toc-link');
				tocLinks.forEach((link) => {
					link.addEventListener('click', (e) => {
						e.preventDefault();
						const targetId = link.getAttribute('href')?.slice(1) || '';
						const targetElement = document.getElementById(targetId);
						if (targetElement) {
							const headerOffset = 80;
							const elementPosition = targetElement.getBoundingClientRect().top;
							const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
							
							window.scrollTo({
								top: offsetPosition,
								behavior: 'smooth'
							});
							// 更新 URL 但不触发滚动
							window.history.pushState(null, '', `#${targetId}`);
						}
					});
				});

				// 高亮当前阅读位置
				const updateActiveTocLink = () => {
					const headings = document.querySelectorAll('.prose h2, .prose h3');
					const tocLinks = document.querySelectorAll('.toc-link');
					
					let current = '';
					const scrollPosition = window.scrollY + 200; // 提前触发距离
					
					headings.forEach((heading) => {
						const headingTop = heading.getBoundingClientRect().top + window.pageYOffset;
						if (scrollPosition >= headingTop) {
							current = heading.id;
						}
					});

					tocLinks.forEach((link) => {
						const slug = link.getAttribute('data-slug');
						if (slug === current) {
							link.classList.add('active');
						} else {
							link.classList.remove('active');
						}
					});
				};

				// 回到顶部按钮
				const backToTopButton = document.getElementById('back-to-top');
				const scrollThreshold = 300;
				
				function toggleBackToTop() {
					if (window.scrollY > scrollThreshold) {
						backToTopButton?.classList.add('visible');
					} else {
						backToTopButton?.classList.remove('visible');
					}
				}
				
				// 使用 throttle 优化滚动性能（合并多个滚动处理）
				let ticking = false;
				window.addEventListener('scroll', () => {
					if (!ticking) {
						window.requestAnimationFrame(() => {
							updateActiveTocLink();
							toggleBackToTop();
							ticking = false;
						});
						ticking = true;
					}
				});
				
				// 初始调用
				updateActiveTocLink();
				toggleBackToTop();
				
				// 点击回到顶部
				backToTopButton?.addEventListener('click', () => {
					window.scrollTo({
						top: 0,
						behavior: 'smooth'
					});
				});
			});
		</script>
	</body>
</html>
